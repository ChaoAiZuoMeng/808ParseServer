package com.chaokong.service.impl;

import com.chaokong.pojo.CalibrationData;
import com.chaokong.service.IParseCalibrationService;
import com.chaokong.tool.MyBuffer;
import com.chaokong.tool.Tools;
import com.chaokong.util.KafkaUtil;
import com.chaokong.util.ParseUtil;

import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.common.serialization.ByteArraySerializer;
import org.apache.log4j.Logger;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Arrays;

@Service
public class ParseCalibrationServiceImpl implements IParseCalibrationService {

	private static Logger calibrationLog = Logger.getLogger("calibrationLog");

	/**
	 * 解析出上传标定文件的数据(HexString) 生成透传内容的数据内容(byte[])
	 *
	 * @param caliHex
	 * @return
	 */
	public CalibrationData parseCalibrationData(String caliHex) {

		calibrationLog.info("接收到标定数据==" + caliHex);
		String[] split = caliHex.split(":");
		String simNo = split[0];
		while(simNo.length() < 12) {
			simNo = "0" + simNo;
		}
		String messageContent = split[1];
		messageContent = messageContent.replace(",", "");
		messageContent = messageContent.replace("\n", "");
		messageContent = messageContent.replace("\\", "");
		messageContent = messageContent.replace(" ", "");
		byte[] bytes = Tools.HexString2Bytes(messageContent);

		MyBuffer myBuffer = new MyBuffer(bytes);
		// 车牌号[12]
		byte[] car_no = myBuffer.gets(12);
		// 额定载重[4]
		int zaizhong_eding = myBuffer.getInt();
		// 分度值[2]
		short aShort = myBuffer.getShort();
		// 传感器个数[1]
		byte no_sensor = myBuffer.get();
		// 单传感器记录数[2]
		short log_single = myBuffer.getShort();
		// 标定数据集合体
		ArrayList<byte[]> logs = new ArrayList();
		int i1 = (no_sensor + 1) * 2;
		for (int i = log_single; i > 0; i--) {
			byte[] gets = myBuffer.gets(i1);
			logs.add(gets);
		}
		// CRC32校验码[4]
		int anInt = myBuffer.getInt();
		MyBuffer buff = new MyBuffer(20 + logs.size() * ((byte[]) logs.get(0)).length * 2);
		buff.put(10);
		buff.put(zaizhong_eding * 100);
		buff.put(no_sensor + 0);
		buff.put(log_single);
		buff.put(new byte[]{0, 0, 0, 0, 0, 0});
		for (byte[] log : logs) {
			buff.put(new byte[]{0, 0});
			buff.put(log[log.length - 2]);
			buff.put(log[log.length - 1]);
			for (int i = 0; i < log.length - 2; i += 2) {
				buff.put(new byte[]{0, 0});
				buff.put(log[i]);
				buff.put(log[i + 1]);
			}
		}
		buff.getBuff().reset();
		CalibrationData caliData = new CalibrationData();
		caliData.setSimNo(simNo);
		caliData.setCaliDataBuf(buff.gets(buff.getlength()));
		return caliData;
	}

	public static void main(String[] args) {
		String caliHex = "17395501429:e9b281512d373631345200000000791800320601b3738c702c601572de6ba15e7a0000738270235fff72c96b015dd200327379701b5fe972b56a625d2b0064737070125fd472a169c25c8300967367700a5fbe728d69235bdc00c8735e70015fa8727968835b3400fa73556ff95f93726567e45a8d012c734c6ff05f7d7251674459e5015e73436fe85f67723c66a5593e0190733a6fdf5f5272286605589701c273316fd75f3c7214656657ef01f473286fce5f26720064c657480226731f6fc65f1171ec642756a0025873166fbd5efb71d8638855f9028a730d6fb55ee671c462e8555102bc73046fad5ed071b0624954aa02ee72fb6fa45eba719b61a95402032072f26f9c5ea57187610a535b035272e96f935e8f7173606a52b4038472e06f8b5e79715f5fcb520c03b672d76f825e64714b5f2b516503e872ce6f7a5e4e71375e8c50bd041a72c56f715e3871235dec5016044c72bc6f695e23710f5d4d4f6e047e72b36f605e0d70fa5cae4ec704b072aa6f585df770e65c0e4e1f04e272a16f4f5de270d25b6f4d78051472986f475dcc70be5acf4cd10546728f6f3f5db770aa5a304c29057872866f365da1709659904b8205aa727d6f2e5d8b708258f14ada05dc72746f255d76706d58514a33060e726b6f1d5d60705957b2498b064072626f145d4a7045571248e4067272596f0c5d3570315673483c06a472506f035d1f701d55d4479506d672476efb5d097009553446ee0708723e6ef25cf46ff554954646073a72356eea5cde6fe153f5459f076c722c6ee15cc96fcc535644f7079e72236ed95cb36fb852b6445007d0721a6ed15c9d6fa4521743a8080272116ec85c886f9051774301083472086ec05c726f7c50d84259086671ff6eb75c5c6f68503841b2089871f66eaf5c476f544f99410b08ca71ed6ea65c316f404ef9406308fc71e46e9e5c1b6f2b4e5a3fbc092e71db6e955c066f174dbb3f14096071d26e8d5bf06f034d1b3e6d099271c96e845bda6eef4c7c3dc509c471c06e7c5bc56edb4bdc3d1e09f671b76e735baf6ec74b3d3c760a2871ae6e6b5b9a6eb34a9d3bcf0a5a71a56e635b846e9e49fe3b280a8c719c6e5a5b6e6e8a495e3a800abe71936e525b596e7648bf39d90af0718a6e495b436e62481f39310b2271816e415b2d6e4e4780388a0b5471786e385b186e3a46e137e20b86716f6e305b026e264641373b0bb871666e275aec6e1245a236930bea715d6e1f5ad76dfd450235ec0c1c71546e165ac16de9446335450c4e714b6e0e5aac6dd543c3349d0c8071426e055a966dc1432433f60cb271396dfd5a806dad4284334e0ce471306df55a6b6d9941e532a70d1671276dec5a556d85414531ff0d48711e6de45a3f6d7140a631580d7a71156ddb5a2a6d5c400730b00dac710b6dd35a146d483f6730090dde71026dca59fe6d343ec82f620e1070f96dc259e96d203e282eba0e4270f06db959d36d0c3d892e130e7470e76db159bd6cf83ce92d6b0ea670de6da859a86ce43c4a2cc40ed870d56da059926cd03baa2c1c0f0a70cc6d97597d6cbb3b0b2b750f3c70c36d8f59676ca73a6b2acd0f6e70ba6d8659516c9339cc2a260fa070b16d7e593c6c7f392c297f0fd270a86d7659266c6b388d28d71004709f6d6d59106c5737ee2830103670966d6558fb6c43374e27881068708d6d5c58e56c2e36af26e1109a70846d5458cf6c1a360f263910cc707b6d4b58ba6c063570259210fe70726d4358a46bf234d024ea113070696d3a588e6bde34312443116270606d3258796bca3391239c119470576d2958636bb632f222f411c6704e6d21584e6ba23252224d11f870456d1858386b8d31b321a5122a703c6d1058226b79311420fe125c70336d08580d6b6530742056128e702a6cff57f76b512fd51faf12c070216cf757e16b3d2f351f0712f270186cee57cc6b292e961e601324700f6ce657b66b152df61db9135670066cdd57a06b012d571d1113886ffd6cd5578b6aec2cb71c6a13ba6ff46ccc57756ad82c181bc213ec6feb6cc457606ac42b781b1b141e6fe26cbb574a6ab02ad91a7314506fd96cb357346a9c2a3a19cc14826fd06caa571f6a88299a192414b46fc76ca257096a7428fb187d14e66fbe6c9a56f36a5f285b17d615186fb56c9156de6a4b27bc1770154a6fac6c8956c86a37271c1770157c6fa36c8056b26a23267d177015ae6f9a6c78569d6a0f25dd177015e06f916c6f568769fb253e177016126f886c67567169e7249e177016446f7f6c5e565c69d323ff177016766f766c56564669be235f177016a86f6d6c4d563169aa22c0177016da6f646c45561b699622211770170c6f5b6c3c5605698221811770173e6f526c3455f0696e20e2177017706f496c2c55da695a2042177017a26f406c2355c469461fa3177017d46f376c1b55af69321f03177018066f2e6c125599691d1e64177018386f256c0a558369091dc41770186a6f1c6c01556e68f51d251770189c6f136bf9555868e11c85177018ce6f0a6bf0554368cd1be6177019006f016be8552d68b91b47177019326ef86bdf551768a51aa7177019646eef6bd7550268911a08177019966ee66bce54ec687c1968177019c86edd6bc654d6686818c9177019fa6ed46bbe54c16854182917701a2c6ecb6bb554ab6840178a17701a5e6ec26bad5495682c177017701a906eb96ba454806818177017701ac26eb06b9c546a6804177017701af46ea76b93545467ef177017701b266e9e6b8b543f67db177017701b586e956b82542967c7177017701b8a6e8b6b7a541467b3177017701bbc6e826b7153fe679f177017701bee6e796b6953e8678b177017701c206e706b6053d36777177017701c526e676b5853bd6763177017701c846e5e6b4f53a7674e177017701cb66e556b475392673a177017701ce86e4c6b3f537c6726177017701d1a6e436b3653666712177017701d4c6e3a6b2e535166fe177017701d7e6e316b25533b66ea177017701db06e286b1d532566d6177017701de26e1f6b14531066c2177017701e146e166b0c52fa66ad177017701e466e0d6b0352e56699177017701e786e046afb52cf6685177017701eaa6dfb6af252b96671177017701edc6df26aea52a4665d177017701f0e6de96ae1528e6649177017701f406de06ad952786635177017701f726dd76ad152636620177017701fa46dce6ac8524d660c177017701fd66dc56ac0523765f81770177020086dbc6ab7522265e417701770203a6db36aaf520c65d017701770206c6daa6aa651f765bc17701770209e6da16a9e51e165a81770177020d06d986a9551cb65941770177021026d8f6a8d51b6657f1770177021346d866a8451a0656b1770177021666d7d6a7c518a65571770177021986d746a73517565431770177021ca6d6b6a6b515f652f1770177021fc6d626a635149651b17701770222e6d596a5a513465071770177022606d506a52511e64f31770177022926d476a49510864de1770177022c46d3e6a4150f364ca1770177022f66d356a3850dd64b61770177023286d2c6a3050c864a217701770235a6d236a2750b2648e17701770238c6d1a6a1f509c647a1770177023be6d116a16508764661770177023f06d086a0e507164521770177024226cff6a05505b643d1770177024546cf669fd504664291770177024866ced69f5503064151770177024b86ce469ec501a64011770177024ea6cdb69e4500563ed17701770251c6cd269db4fef63d917701770254e6cc969d34fda63c51770177025806cc069ca4fc463b01770177025b26cb769c24fae639c1770177025e46cae69b94f9963881770177026166ca569b14f8363741770177026486c9c69a84f6d636017701770267a6c9369a04f58634c1770177026ac6c8a69974f4263381770177026de6c81698f4f2c63241770177027106c7869874f17630f1770177027426c6f697e4f0162fb1770177027746c6669764eeb62e71770177027a66c5d696d4ed662d31770177027d86c5469654ec062bf17701770280a6c4b695c4eab62ab17701770283c6c4269544e95629717701770286e6c39694b4e7f62831770177028a06c3069434e6a626e1770177028d26c27693a4e54625a1770177029046c1e69324e3e62461770177029366c1569294e2962321770177029686c0b69214e13621e17701770299a6c0269184dfd620a1770177029cc6bf969104de861f61770177029fe6bf069084dd261e1177017702a306be768ff4dbc61cd177017702a626bde68f74da761b9177017702a946bd568ee4d9161a5177017702ac66bcc68e64d7c6191177017702af86bc368dd4d66617d177017702b2a6bba68d54d506169177017702b5c6bb168cc4d3b6155177017702b8e6ba868c44d256140177017702bc06b9f68bb4d0f612c177017702bf26b9668b34cfa6118177017702c246b8d68aa4ce46104177017702c566b8468a24cce60f0177017702c886b7b689a4cb960dc177017702cba6b7268914ca360c8177017702cec6b6968894c8e60b4177017702d1e6b6068804c78609f177017702d506b5768784c62608b177017702d826b4e686f4c4d6077177017702db46b4568674c376063177017702de66b3c685e4c21604f177017702e186b3368564c0c603b177017702e4a6b2a684d4bf66027177017702e7c6b2168454be06013177017702eae6b18683c4bcb5ffe177017702ee06b0f68344bb55fea177017702f126b06682c4b9f5fd6177017702f446afd68234b8a5fc2177017702f766af4681b4b745fae177017702fa86aeb68124b5f5f9a177017702fda6ae2680a4b495f8617701770300c6ad968014b335f7117701770303e6ad067f94b1e5f5d1770177030706ac767f04b085f491770177030a26abe67e84af25f351770177030d46ab567df4add5f211770177031066aac67d74ac75f0d1770177031386aa367ce4ab15ef917701770316a6a9a67c64a9c5ee517701770319c6a9167be4a865ed01770177031ce6a8867b54a715ebc1770177032006a7f67ad4a5b5ea81770177032326a7667a44a455e941770177032646a6d679c4a305e801770177032966a6467934a1a5e6c1770177032c86a5b678b4a045e581770177032fa6a52678249ef5e4417701770332c6a49677a49d95e2f17701770335e6a40677149c35e1b1770177033906a37676949ae5e071770177033c26a2e676049985df31770177033f46a25675849825ddf1770177034266a1c6750496d5dcb1770177034586a13674749575db717701770348a6a0a673f49425da21770177034bc6a016736492c5d8e1770177034ee69f8672e49165d7a17701770352069ef672549015d6617701770355269e6671d48eb5d5217701770358469dd671448d55d3e1770177035b669d4670c48c05d2a1770177035e869cb670348aa5d1617701770361a69c266fb48945d0117701770364c69b966f2487f5ced17701770367e69b066ea48695cd91770177036b069a766e248535cc51770177036e2699e66d9483e5cb1177017703714699566d148285c9d177017703746698b66c848135c89177017703778698266c047fd5c751770177037aa697966b747e75c601770177037dc697066af47d25c4c17701770380e696766a647bc5c38177017703840695e669e47a65c241770177038726955669547915c101770177038a4694c668d477b5bfc1770177038d66943668447655be8177017703908693a667c47505bd417701770393a69316673473a5bbf17701770396c6928666b47255bab17701770399e691f6663470f5b971770177039d06916665a46f95b83177017703a02690d665246e45b6f177017703a346904664946ce5b5b177017703a6668fb664146b85b47177017703a9868f2663846a35b32177017703aca68e96630468d5b1e177017703afc68e0662746775b0a177017703b2e68d7661f46625af6177017703b6068ce6616464c5ae2177017703b9268c5660e46365ace177017703bc468bc660546215aba177017703bf668b365fd460b5aa6177017703c2868aa65f545f65a91177017703c5a68a165ec45e05a7d177017703c8c689865e445ca5a69177017703cbe688f65db45b55a55177017703cf0688665d3459f5a41177017703d22687d65ca45895a2d177017703d54687465c245745a19177017703d86686b65b9455e5a05177017703db8686265b1454859f0177017703dea685965a8453359dc177017703e1c685065a0451d59c8177017703e4e68476597450859b4177017703e80683e658f44f259a0177017703eb26835658744dc598c177017703ee4682c657e44c75978177017703f166823657644b15963177017703f48681a656d449b594f177017703f7a681165654486593b177017703fac6808655c44705927177017703fde67ff6554445a591317701770401067f6654b444558ff17701770404267ed6543442f58eb17701770407467e4653a441958d71770177040a667db6532440458c21770177040d867d2652943ee58ae17701770410a67c9652143d9589a17701770413c67c0651943c3588617701770416e67b7651043ad58721770177041a067ae65084398585e1770177041d267a564ff4382584a177017704204679c64f7436c5836177017704236679364ee43575821177017704268678a64e64341580d17701770429a678164dd432b57f91770177042cc677864d5431657e51770177042fe676f64cc430057d1177017704330676664c442ea57bd177017704362675d64bb42d557a9177017704394675464b342bf57951770177043c6674b64ab42aa57801770177043f8674264a24294576c17701770442a6739649a427e575817701770445c673064914269574417701770448e67276489425357301770177044c0671e6480423d571c1770177044f26715647842285708177017704524670b646f421256f31770177045566702646741fc56df17701770458866f9645e41e756cb1770177045ba66f0645641d156b71770177045ec66e7644d41bc56a317701770461e66de644541a6568f17701770465066d5643c4190567b17701770468266cc6434417b56671770177046b466c3642c416556521770177046e666ba6423414f563e17701770471866b1641b413a562a17701770474a66a864124124561617701770477c669f640a410e56021770177047ae6696640140f955ee1770177047e0668d63f940e355da177017704812668463f040cd55c6177017704844667b63e840b855b1177017704876667263df40a2559d1770177048a8666963d7408d55891770177048da666063ce4077557517701770490c665763c64061556117701770493e664e63be404c554d177017704970664563b5403655391770177049a2663c63ad402055241770177049d4663363a4400b5510177017704a06662a639c3ff554fc177017704a38662163933fdf54e8177017704a6a6618638b3fca54d4177017704a9c660f63823fb454c0177017704ace6606637a3f9f54ac177017704b0065fd63713f895498177017704b3265f463693f735483177017704b6465eb63603f5e546f177017704b9665e263583f48545b177017704bc865d963503f325447177017704bfa65d063473f1d5433177017704c2c65c7633f3f07541f177017704c5e65be63363ef1540b177017704c9065b5632e3edc53f7177017704cc265ac63253ec653e2177017704cf465a3631d3eb053ce177017704d26659a63143e9b53ba177017704d586591630c3e8553a6177017704d8a658863033e705392177017704dbc657f62fb3e5a537e177017704dee657662f23e44536a177017704e20656d62ea3e2f5356177017704e52656462e23e195341177017704e84655b62d93e03532d177017704eb6655262d13dee5319177017704ee8654962c83dd85305177017704f1a654062c03dc252f1177017704f4c653762b73dad52dd177017704f7e652e62af3d9752c9177017704fb0652562a63d8252b4177017704fe2651c629e3d6c52a0177017705014651362953d56528c177017705046650a628d3d415278177017705078650162843d2b52641770177050aa64f8627c3d1552501770177050dc64ef62743d00523c17701770510e64e6626b3cea522817701770514064dd62633cd4521317701770517264d4625a3cbf51ff1770177051a464cb62523ca951eb1770177051d664c262493c9351d717701770520864b962413c7e51c317701770523a64b062383c6851af17701770526c64a762303c53519b17701770529e649e62273c3d51871770177052d06494621f3c275172177017705302648b62163c12515e1770177053346482620e3bfc514a177017705366647962053be65136177017705398647061fd3bd151221770177053ca646761f53bbb510e1770177053fc645e61ec3ba550fa17701770542e645561e43b9050e5177017705460644c61db3b7a50d1177017705492644361d33b6450bd1770177054c46810dd14"; 
		ParseCalibrationServiceImpl pcs = new ParseCalibrationServiceImpl();
		CalibrationData calibrationData = pcs.parseCalibrationData(caliHex);
		System.err.println("simNo: " + calibrationData.getSimNo());
		System.err.println("data: " + Tools.bytes2hex(calibrationData.getCaliDataBuf()));
		String simNo = calibrationData.getSimNo();
		byte[] caliDataBuf = calibrationData.getCaliDataBuf();
		KafkaUtil kafka = new KafkaUtil();
		KafkaProducer producer = kafka.getProducer(ByteArraySerializer.class.getName());
		kafka.producerSend(producer, caliDataBuf, "caliDataDown", simNo);
	}
}
